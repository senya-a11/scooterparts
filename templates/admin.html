<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/static/favicon/favicon.ico" type="image/x-icon">
  <title>Admin ‚Äî IMPORT</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#080A0F; --bg-2:#0D1017; --bg-3:#12161E;
      --surface:#161B24; --surface-2:#1E2533;
      --border:rgba(255,255,255,0.06); --border-hover:rgba(255,255,255,0.12);
      --text:#F0F2F5; --text-2:#8B92A5; --text-3:#4E5568;
      --accent:#00D4FF; --accent-dim:rgba(0,212,255,0.12); --accent-glow:rgba(0,212,255,0.25);
      --green:#00E5A0; --green-dim:rgba(0,229,160,0.12);
      --red:#FF4757; --red-dim:rgba(255,71,87,0.12);
      --amber:#FFB020; --amber-dim:rgba(255,176,32,0.12);
      --radius:10px; --radius-lg:16px; --radius-xl:24px;
      --font-d:'Syne',sans-serif; --font-b:'DM Sans',sans-serif;
      --ease:cubic-bezier(0.16,1,0.3,1);
    }
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    body{font-family:var(--font-b);background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased}
    body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.4}
    ::-webkit-scrollbar{width:6px} ::-webkit-scrollbar-track{background:var(--bg-2)} ::-webkit-scrollbar-thumb{background:var(--surface-2);border-radius:3px}

    /* Login */
    .login-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:1.5rem;background:var(--bg);position:relative;overflow:hidden}
    .login-bg-glow{position:absolute;top:-200px;left:50%;transform:translateX(-50%);width:700px;height:500px;background:radial-gradient(ellipse,rgba(0,212,255,.06) 0%,transparent 70%);pointer-events:none}
    .login-card{background:var(--bg-3);border:1px solid var(--border-hover);border-radius:var(--radius-xl);padding:2.5rem;width:100%;max-width:400px;box-shadow:0 12px 40px rgba(0,0,0,.6);animation:fadeUp .4s var(--ease)}
    @keyframes fadeUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
    .login-logo{display:flex;align-items:center;justify-content:center;gap:.625rem;font-family:var(--font-d);font-size:1.375rem;font-weight:700;margin-bottom:.5rem}
    .login-mark{width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-size:24px;position:relative}
    .login-mark::after{content:'‚ö°';position:absolute;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 10px rgba(255,215,0,.4))}
    .login-logo span{color:var(--accent)}
    .login-sub{text-align:center;font-size:.8125rem;color:var(--text-3);margin-bottom:2rem}
    .badge-admin{display:inline-flex;align-items:center;gap:.375rem;padding:.25rem .75rem;background:var(--amber-dim);color:var(--amber);border:1px solid rgba(255,176,32,.25);border-radius:100px;font-size:.75rem;font-weight:600;margin:0 auto .5rem;width:fit-content}

    .form-group{margin-bottom:1.125rem}
    .form-label{display:block;font-size:.8125rem;font-weight:600;color:var(--text-2);margin-bottom:.5rem;letter-spacing:.04em;text-transform:uppercase}
    .form-input,.form-select,.form-textarea{width:100%;padding:.75rem 1rem;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:var(--font-b);font-size:.9375rem;outline:none;transition:all .2s}
    .form-input::placeholder,.form-textarea::placeholder{color:var(--text-3)}
    .form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent);background:var(--bg-3);box-shadow:0 0 0 3px var(--accent-dim)}
    .form-select{-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%238B92A5'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .625rem center;background-size:14px;padding-right:2rem;cursor:pointer}
    .form-textarea{resize:vertical;min-height:90px;line-height:1.6}
    .form-hint{font-size:.75rem;color:var(--text-3);margin-top:.375rem}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.625rem 1.25rem;font-family:var(--font-b);font-size:.875rem;font-weight:600;border-radius:var(--radius);border:none;cursor:pointer;text-decoration:none;transition:all .2s;white-space:nowrap}
    .btn-primary{background:var(--accent);color:#080A0F;font-weight:700;box-shadow:0 0 20px var(--accent-glow)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 0 30px rgba(0,212,255,.4)}
    .btn-secondary{background:var(--surface-2);color:var(--text);border:1px solid var(--border-hover)}
    .btn-secondary:hover{background:rgba(255,255,255,.08)}
    .btn-ghost{background:transparent;color:var(--text-2);border:1px solid var(--border)}
    .btn-ghost:hover{color:var(--text);border-color:var(--border-hover)}
    .btn-danger{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,71,87,.25)}
    .btn-danger:hover{background:rgba(255,71,87,.2)}
    .btn-amber{background:var(--amber-dim);color:var(--amber);border:1px solid rgba(255,176,32,.25)}
    .btn-success{background:var(--green-dim);color:var(--green);border:1px solid rgba(0,229,160,.25)}
    .btn-sm{padding:.375rem .875rem;font-size:.8125rem}
    .btn-xs{padding:.25rem .625rem;font-size:.75rem;border-radius:6px}

    .msg{padding:.875rem 1.125rem;border-radius:var(--radius);font-size:.875rem;font-weight:500;margin-bottom:.75rem;border:1px solid transparent}
    .msg-error{background:var(--red-dim);color:var(--red);border-color:rgba(255,71,87,.2)}
    .msg-success{background:var(--green-dim);color:var(--green);border-color:rgba(0,229,160,.2)}
    .msg-info{background:var(--accent-dim);color:var(--accent);border-color:rgba(0,212,255,.2)}

    /* Admin layout */
    .admin-panel{display:none;flex-direction:column;min-height:100vh}
    .admin-header{background:rgba(8,10,15,.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
    .admin-header-inner{max-width:1400px;margin:0 auto;padding:0 1.5rem;display:flex;align-items:center;justify-content:space-between;height:62px;gap:1.5rem}
    .admin-logo{display:flex;align-items:center;gap:.625rem;font-family:var(--font-d);font-size:1.125rem;font-weight:700}
    .admin-logo-mark{width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:18px;position:relative}
    .admin-logo-mark::after{content:'‚ö°';position:absolute;background:linear-gradient(135deg,#FFD700 0%,#FFA500 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 6px rgba(255,215,0,.3))}
    .admin-logo span{color:var(--accent)}
    .admin-badge{font-size:.6875rem;font-weight:700;padding:.2rem .5rem;background:var(--amber-dim);color:var(--amber);border-radius:4px}
    .admin-nav{display:flex;gap:.25rem;overflow-x:auto}
    .admin-nav-btn{display:flex;align-items:center;gap:.5rem;padding:.5rem 1rem;background:transparent;border:none;border-radius:var(--radius);color:var(--text-2);cursor:pointer;font-family:var(--font-b);font-size:.8125rem;font-weight:600;transition:all .2s;white-space:nowrap}
    .admin-nav-btn:hover{background:rgba(255,255,255,.06);color:var(--text)}
    .admin-nav-btn.active{background:var(--accent-dim);color:var(--accent)}
    .admin-actions{display:flex;align-items:center;gap:.75rem}

    .admin-body{max-width:1400px;margin:0 auto;padding:2rem 1.5rem;flex:1}

    /* Sections */
    .admin-section{display:none}
    .admin-section.active{display:block}
    .section-title{font-family:var(--font-d);font-size:1.5rem;font-weight:800;letter-spacing:-.02em;margin-bottom:1.5rem}

    /* Stats grid */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}
    .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.25rem}
    .stat-label{font-size:.75rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text-3);margin-bottom:.5rem}
    .stat-val{font-family:'JetBrains Mono',monospace;font-size:2rem;font-weight:700;letter-spacing:-.01em}
    .stat-val.green{color:var(--green)} .stat-val.accent{color:var(--accent)} .stat-val.amber{color:var(--amber)} .stat-val.red{color:var(--red)}

    /* Tables */
    .table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th{padding:.875rem 1rem;background:var(--bg-3);font-size:.75rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--text-3);text-align:left;border-bottom:1px solid var(--border)}
    td{padding:.875rem 1rem;font-size:.875rem;border-bottom:1px solid var(--border);vertical-align:middle}
    tr:last-child td{border-bottom:none}
    .editable-cell{cursor:pointer;transition:background .2s}
    .editable-cell:hover{background:rgba(0,212,255,0.05);text-decoration:underline;text-decoration-style:dotted}
    .badge{display:inline-flex;align-items:center;padding:.25rem .625rem;border-radius:6px;font-size:.75rem;font-weight:700}
    .badge-accent{background:var(--accent-dim);color:var(--accent);border:1px solid rgba(0,212,255,.2)}
    .badge-success{background:var(--green-dim);color:var(--green);border:1px solid rgba(0,229,160,.2)}
    .badge-warning{background:var(--amber-dim);color:var(--amber);border:1px solid rgba(255,176,32,.2)}
    .badge-danger{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,71,87,.2)}
    tr:hover td{background:rgba(255,255,255,.02)}
    .product-img-cell{width:48px;height:48px;background:var(--bg-3);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.25rem;overflow:hidden;flex-shrink:0}
    .product-img-cell img{width:100%;height:100%;object-fit:cover}

    /* Category management */
    .cat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-bottom:2rem}
    .cat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.25rem;display:flex;align-items:center;gap:1rem;transition:border-color .2s}
    .cat-card:hover{border-color:var(--border-hover)}
    .cat-emoji-box{width:52px;height:52px;background:var(--bg-3);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.75rem;flex-shrink:0}
    .cat-info{flex:1;min-width:0}
    .cat-name{font-weight:700;font-size:.9375rem}
    .cat-meta{font-size:.75rem;color:var(--text-3);margin-top:.125rem}
    .cat-actions{display:flex;gap:.375rem}
    .add-cat-form{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.5rem;margin-bottom:1.5rem}
    .add-cat-title{font-family:var(--font-d);font-size:1rem;font-weight:700;margin-bottom:1.25rem}
    .cat-form-row{display:grid;grid-template-columns:80px 1fr 1fr auto;gap:.75rem;align-items:end}
    .emoji-picker{display:flex;gap:.375rem;flex-wrap:wrap;margin-top:.5rem}
    .emoji-opt{width:36px;height:36px;background:var(--bg-3);border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.125rem;cursor:pointer;transition:all .2s}
    .emoji-opt:hover,.emoji-opt.selected{border-color:var(--accent);background:var(--accent-dim)}

    /* Image upload */
    .img-upload-area{border:2px dashed var(--border);border-radius:var(--radius-lg);padding:2rem;text-align:center;cursor:pointer;transition:all .2s;position:relative}
    .img-upload-area:hover{border-color:var(--accent);background:var(--accent-dim)}
    .img-upload-area input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
    .img-preview{margin-top:1rem;display:none}
    .img-preview img{max-width:160px;max-height:120px;border-radius:var(--radius);object-fit:cover;border:1px solid var(--border)}

    /* Orders */
    .order-status{display:inline-flex;align-items:center;gap:.375rem;padding:.25rem .625rem;border-radius:100px;font-size:.75rem;font-weight:700}
    .status-pending{background:var(--amber-dim);color:var(--amber)}
    .status-confirmed,.status-processing{background:var(--accent-dim);color:var(--accent)}
    .status-shipped{background:rgba(147,112,219,.15);color:#9B59B6}
    .status-delivered{background:var(--green-dim);color:var(--green)}
    .status-cancelled{background:var(--red-dim);color:var(--red)}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);z-index:500;display:none;align-items:center;justify-content:center;padding:1rem}
    .modal-overlay.active{display:flex}
    .modal-box{background:var(--bg-3);border:1px solid var(--border-hover);border-radius:var(--radius-xl);padding:2rem;width:100%;max-width:500px;box-shadow:0 12px 40px rgba(0,0,0,.6);animation:fadeUp .3s var(--ease);max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem}
    .modal-title{font-family:var(--font-d);font-size:1.125rem;font-weight:700}
    .modal-close{background:none;border:none;color:var(--text-3);font-size:1.25rem;cursor:pointer;padding:.25rem;transition:color .2s;line-height:1}
    .modal-close:hover{color:var(--text)}

    /* Toast */
    .toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(1rem);background:var(--surface-2);color:var(--text);padding:.75rem 1.5rem;border-radius:100px;font-size:.875rem;opacity:0;pointer-events:none;transition:all .3s;z-index:9000;white-space:nowrap;border:1px solid var(--border-hover)}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast-success{background:var(--green-dim);color:var(--green);border-color:rgba(0,229,160,.25)}
    .toast-error{background:var(--red-dim);color:var(--red);border-color:rgba(255,71,87,.25)}
    /* Mobile hamburger menu */
    .mobile-menu-btn{display:none;flex-direction:column;gap:4px;background:none;border:none;cursor:pointer;padding:.75rem;margin-right:.5rem;z-index:300}
    .mobile-menu-btn span{width:20px;height:2px;background:var(--text);border-radius:2px;transition:all .3s}
    .mobile-menu-btn.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}
    .mobile-menu-btn.active span:nth-child(2){opacity:0}
    .mobile-menu-btn.active span:nth-child(3){transform:rotate(-45deg) translate(5px,-5px)}
    
    @media(max-width:768px){
      .mobile-menu-btn{display:flex}
      .admin-nav{position:fixed;left:0;top:62px;bottom:0;width:280px;max-width:85vw;background:var(--bg-2);border-right:1px solid var(--border);flex-direction:column;padding:1rem;gap:.5rem;transform:translateX(-100%);transition:transform .3s var(--ease);overflow-y:auto;z-index:200}
      .admin-nav.active{transform:translateX(0)}
      .admin-nav-btn{width:100%;justify-content:flex-start;padding:.75rem 1rem}
      .admin-actions{gap:.5rem}
      .admin-actions .btn{padding:.5rem .875rem;font-size:.8125rem}
    }    /* IMPORT Logo - Lightning bolt effect */
    .logo-mark,.admin-logo-mark,.login-mark{
      position:relative;
      overflow:hidden;
    }
    .logo-mark::after,.admin-logo-mark::after,.login-mark::after{
      content:'‚ö°';
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(135deg,#00D4FF 0%,#0099CC 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      font-size:inherit;
    }


  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-bg-glow"></div>
  <div class="login-card">
    <div class="login-logo">
      <div class="login-mark">‚ö°</div>
      <span>IM<span>PORT</span></span>
    </div>
    <div style="text-align:center;margin-bottom:1.5rem">
      <div class="badge-admin">‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</div>
    </div>
    <div id="loginMsg"></div>
    <form id="loginForm">
      <div class="form-group">
        <label class="form-label">–õ–æ–≥–∏–Ω</label>
        <input type="text" class="form-input" id="loginUser" value="admin" placeholder="admin" required>
      </div>
      <div class="form-group">
        <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
        <input type="password" class="form-input" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>
      <button type="submit" class="btn btn-primary" style="width:100%;margin-top:.25rem">–í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å ‚Üí</button>
    </form>
    <p style="text-align:center;margin-top:1rem"><a href="/" style="font-size:.8125rem;color:var(--text-3);text-decoration:none">‚Üê –ù–∞ —Å–∞–π—Ç</a></p>
  </div>
</div>

<!-- ADMIN PANEL -->
<div class="admin-panel" id="adminPanel">
  <header class="admin-header">
    <div class="admin-header-inner">
      <div style="display:flex;align-items:center;gap:1rem">
        <button class="mobile-menu-btn" id="mobileMenuBtn">
          <span></span><span></span><span></span>
        </button>
        <div class="admin-logo">
          <div class="admin-logo-mark">‚ö°</div>
          <span>IM<span>PORT</span></span>
          <span class="admin-badge">ADMIN</span>
        </div>
      </div>
      <nav class="admin-nav" id="adminNav">
        <button class="admin-nav-btn active" data-sec="dashboard">üìä –î–∞—à–±–æ—Ä–¥</button>
        <button class="admin-nav-btn" data-sec="products">üì¶ –¢–æ–≤–∞—Ä—ã</button>
        <button class="admin-nav-btn" data-sec="categories">üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
        <button class="admin-nav-btn" data-sec="orders">üõí –ó–∞–∫–∞–∑—ã</button>
        <button class="admin-nav-btn" data-sec="top-clients">üë• –¢–æ–ø –∫–ª–∏–µ–Ω—Ç—ã</button>
        <button class="admin-nav-btn" data-sec="crm">üìù CRM</button>
        <button class="admin-nav-btn" data-sec="add-product">‚ûï –û–±—ã—á–Ω—ã–π —Ç–æ–≤–∞—Ä</button>
        <button class="admin-nav-btn" data-sec="add-product-specs">üîß –¢–æ–≤–∞—Ä —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏</button>
      </nav>
      <div class="admin-actions">
        <a href="/" class="btn btn-ghost btn-sm">–ù–∞ —Å–∞–π—Ç ‚Üó</a>
        <button class="btn btn-ghost btn-sm" id="logoutBtn">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </header>

  <div class="admin-body">

    <!-- ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ -->
    <div class="admin-section active" id="sec-dashboard">
      <h2 class="section-title">üìä –î–∞—à–±–æ—Ä–¥</h2>
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card"><div class="stat-label">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></div>
      </div>
      <div class="msg msg-info" style="margin-bottom:1.5rem">
        üí≥ <strong>–≠–∫–≤–∞–π—Ä–∏–Ω–≥:</strong> –ó–∞–≥–ª—É—à–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞. –î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —Å–º. –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ <code>backend/main.py ‚Üí /api/payment/create</code>. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ÆKassa, –¢–∏–Ω—å–∫–æ—Ñ—Ñ, Stripe.
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ PRODUCTS ‚îÄ‚îÄ‚îÄ -->
    <div class="admin-section" id="sec-products">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">
        <h2 class="section-title" style="margin-bottom:0">üì¶ –¢–æ–≤–∞—Ä—ã</h2>
        <button class="btn btn-primary" onclick="switchSection('add-product')">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
      </div>
      <div id="productsMsg"></div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>–§–æ—Ç–æ</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–¶–µ–Ω–∞</th><th>–°–∫–ª–∞–¥</th><th>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</th><th>–í –Ω–∞–ª–∏—á–∏–∏</th><th>–ü—Ä–µ–¥–∑–∞–∫–∞–∑</th><th>–•–∏—Ç</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
          <tbody id="productsTableBody"><tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-3)">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ CATEGORIES ‚îÄ‚îÄ‚îÄ -->
    <div class="admin-section" id="sec-categories">
      <h2 class="section-title">üè∑Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h2>
      <div id="catMsg"></div>

      <!-- Add category form -->
      <div class="add-cat-form">
        <div class="add-cat-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div>
        <div class="cat-form-row">
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">Emoji</label>
            <input type="text" class="form-input" id="newCatEmoji" value="üì¶" maxlength="4" style="text-align:center;font-size:1.375rem">
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">Slug (–ª–∞—Ç–∏–Ω–∏—Ü–µ–π)</label>
            <input type="text" class="form-input" id="newCatSlug" placeholder="new_category">
            <div class="form-hint">–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã, _</div>
          </div>
          <div class="form-group" style="margin-bottom:0">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å.)</label>
            <input type="text" class="form-input" id="newCatName" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è">
          </div>
          <button class="btn btn-primary" onclick="createCategory()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
        <div style="margin-top:1rem">
          <label class="form-label">–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä Emoji</label>
          <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-opt" onclick="pickEmoji('üì¶')">üì¶</div>
            <div class="emoji-opt" onclick="pickEmoji('üîã')">üîã</div>
            <div class="emoji-opt" onclick="pickEmoji('‚öôÔ∏è')">‚öôÔ∏è</div>
            <div class="emoji-opt" onclick="pickEmoji('üì±')">üì±</div>
            <div class="emoji-opt" onclick="pickEmoji('üõë')">üõë</div>
            <div class="emoji-opt" onclick="pickEmoji('üõû')">üõû</div>
            <div class="emoji-opt" onclick="pickEmoji('üîß')">üîß</div>
            <div class="emoji-opt" onclick="pickEmoji('üí°')">üí°</div>
            <div class="emoji-opt" onclick="pickEmoji('üéõÔ∏è')">üéõÔ∏è</div>
            <div class="emoji-opt" onclick="pickEmoji('üîå')">üîå</div>
            <div class="emoji-opt" onclick="pickEmoji('ü™õ')">ü™õ</div>
            <div class="emoji-opt" onclick="pickEmoji('‚ö°')">‚ö°</div>
            <div class="emoji-opt" onclick="pickEmoji('üèçÔ∏è')">üèçÔ∏è</div>
            <div class="emoji-opt" onclick="pickEmoji('üõπ')">üõπ</div>
            <div class="emoji-opt" onclick="pickEmoji('ü™ú')">ü™ú</div>
            <div class="emoji-opt" onclick="pickEmoji('üî©')">üî©</div>
          </div>
        </div>
      </div>

      <div class="cat-grid" id="catGrid">
        <div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--text-3)">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ ORDERS ‚îÄ‚îÄ‚îÄ -->
    <div class="admin-section" id="sec-orders">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem">
        <h2 class="section-title" style="margin-bottom:0">üõí –ó–∞–∫–∞–∑—ã</h2>
        <div style="display:flex;gap:.75rem;align-items:center">
          <select class="form-select" id="orderStatusFilter" style="width:auto" onchange="loadOrders()">
            <option value="">–í—Å–µ –∑–∞–∫–∞–∑—ã</option>
            <option value="pending">–û–∂–∏–¥–∞–Ω–∏–µ</option>
            <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</option>
            <option value="processing">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
            <option value="shipped">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</option>
            <option value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
            <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="loadOrders()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div id="ordersMsg"></div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>#</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û–ø–ª–∞—Ç–∞</th><th>–î–∞—Ç–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
          <tbody id="ordersTableBody"><tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-3)">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ TOP CLIENTS ‚îÄ‚îÄ‚îÄ -->
    <div class="admin-section" id="sec-top-clients">
      <h2 class="section-title">üë• –¢–æ–ø –∫–ª–∏–µ–Ω—Ç—ã</h2>
      <div class="msg msg-info" style="margin-bottom:1.5rem">
        üìà –ó–¥–µ—Å—å –ø–æ–∫–∞–∑–∞–Ω—ã —Å–∞–º—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ –ø–æ —Å—É–º–º–µ –ø–æ–∫—É–ø–æ–∫, –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–∫–∞–∑–æ–≤ –∏ –¥–∞—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏.
      </div>
      <div class="table-wrap">
        <table id="topClientsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>–ö–ª–∏–µ–Ω—Ç</th>
              <th>Email</th>
              <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
              <th>–ó–∞–∫–∞–∑–æ–≤</th>
              <th>–û–ø–ª–∞—á–µ–Ω–æ</th>
              <th>–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
              <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑</th>
            </tr>
          </thead>
          <tbody id="topClientsTableBody">
            <tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-3)">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ CRM WITH NOTES ‚îÄ‚îÄ‚îÄ -->
    <div class="admin-section" id="sec-crm">
      <h2 class="section-title">üìù CRM ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h2>
      <p style="color:var(--text-2);margin-bottom:2rem">–î–æ–±–∞–≤–ª—è–π—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö, –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∏—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</p>
      
      <div class="table-wrap">
        <table id="crmTable">
          <thead>
            <tr>
              <th>–ö–ª–∏–µ–Ω—Ç</th>
              <th>–ó–∞–∫–∞–∑–æ–≤</th>
              <th>–û–±—â–∞—è —Å—É–º–º–∞</th>
              <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–∫–∞–∑</th>
              <th>–ó–∞–º–µ—Ç–æ–∫</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="crmTableBody">
            <tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-3)">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal-overlay" id="notesModal">
      <div class="modal" style="max-width:700px">
        <div class="modal-header">
          <h3 class="modal-title">üìù –ó–∞–º–µ—Ç–∫–∏ –æ –∫–ª–∏–µ–Ω—Ç–µ: <span id="notesCustomerName"></span></h3>
          <button class="modal-close" onclick="closeModal('notesModal')">‚úï</button>
        </div>
        <div class="modal-body" style="max-height:500px;overflow-y:auto">
          <div id="notesList"></div>
          <div style="margin-top:1.5rem;padding-top:1.5rem;border-top:1px solid var(--border)">
            <textarea id="newNoteText" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É –æ –∫–ª–∏–µ–Ω—Ç–µ..." style="width:100%;padding:.875rem;background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);font-family:var(--font-b);font-size:.875rem;resize:vertical;min-height:80px;margin-bottom:.75rem"></textarea>
            <button class="btn btn-primary" onclick="saveNote()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ ADD PRODUCT ‚îÄ‚îÄ‚îÄ -->
    <div class="admin-section" id="sec-add-product">
      <h2 class="section-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–±—ã—á–Ω—ã–π —Ç–æ–≤–∞—Ä</h2>
      <div class="msg msg-info" style="margin-bottom:1.5rem">
        üì¶ –û–±—ã—á–Ω—ã–π —Ç–æ–≤–∞—Ä ‚Äî —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä —Å –æ–¥–Ω–æ–π —Ü–µ–Ω–æ–π, –æ–¥–Ω–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ –æ–¥–Ω–∏–º –Ω–∞–±–æ—Ä–æ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.
        –ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–µ–Ω —Ç–æ–≤–∞—Ä —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≤–µ—Ä—Å–∏—è–º–∏/–ø–æ–∫–æ–ª–µ–Ω–∏—è–º–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ "–¢–æ–≤–∞—Ä —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏".
      </div>
      <div id="addProductMsg"></div>
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.75rem;max-width:680px">
        <form id="addProductForm">
          <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
            <input type="text" name="name" class="form-input" placeholder="–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä 36V 15Ah" required>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
            <div class="form-group">
              <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
              <select name="category" class="form-select" id="productCategorySelect" required>
                <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">–¶–µ–Ω–∞ (‚ÇΩ) *</label>
              <input type="number" name="price" class="form-input" placeholder="1990" min="1" step="0.01" required>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ *</label>
            <textarea name="description" class="form-textarea" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞‚Ä¶" required rows="4"></textarea>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
            <div class="form-group">
              <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
              <input type="number" name="stock" class="form-input" value="0" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Ö–∏—Ç</label>
              <select name="featured" class="form-select">
                <option value="false">–ù–µ—Ç</option>
                <option value="true">‚≠ê –î–∞ ‚Äî —Ö–∏—Ç –ø—Ä–æ–¥–∞–∂</option>
              </select>
            </div>
          </div>

          <!-- Image section -->
          <div class="form-group">
            <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
            <div class="img-upload-area" id="uploadArea">
              <input type="file" name="image_file" id="imageFile" accept=".jpg,.jpeg,.png,.gif,.webp" onchange="previewImage(event)">
              <div id="uploadPlaceholder">
                <div style="font-size:2rem;margin-bottom:.5rem">üì∏</div>
                <div style="font-size:.875rem;color:var(--text-2)">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª</div>
                <div style="font-size:.75rem;color:var(--text-3);margin-top:.25rem">JPG, PNG, GIF, WebP ¬∑ –ú–∞–∫—Å. 10 –ú–ë</div>
              </div>
              <div class="img-preview" id="imgPreview">
                <img id="previewImg" src="" alt="Preview">
                <div style="font-size:.75rem;color:var(--text-3);margin-top:.5rem" id="previewFileName"></div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">‚Äî –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
            <input type="url" name="image_url" class="form-input" placeholder="https://example.com/image.jpg">
            <div class="form-hint">–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∞–π–ª, URL –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è</div>
          </div>

          <div style="display:flex;gap:.75rem;flex-wrap:wrap">
            <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
            <button type="reset" class="btn btn-ghost" onclick="clearPreview()">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ ADD PRODUCT WITH SPECS ‚îÄ‚îÄ‚îÄ -->
    <div class="admin-section" id="sec-add-product-specs">
      <h2 class="section-title">üîß –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏</h2>
      <div class="msg msg-info" style="margin-bottom:1.5rem">
        üîß <strong>–¢–æ–≤–∞—Ä —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏</strong> ‚Äî —ç—Ç–æ —Ç–æ–≤–∞—Ä, —É –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π/–ø–æ–∫–æ–ª–µ–Ω–∏–π.<br>
        –ù–∞–ø—Ä–∏–º–µ—Ä: iPhone (–æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä) ‚Üí iPhone 13, iPhone 14, iPhone 15 (—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏).<br>
        –£ –∫–∞–∂–¥–æ–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–≤–æ—è —Ü–µ–Ω–∞, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏ –Ω–∞–ª–∏—á–∏–µ.
      </div>
      <div id="addProductSpecsMsg"></div>
      
      <!-- Step 1: Create main product -->
      <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.75rem;max-width:680px;margin-bottom:1.5rem">
        <h3 style="font-family:var(--font-d);font-size:1.125rem;font-weight:700;margin-bottom:1.25rem">
          –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä
        </h3>
        <form id="addProductWithSpecsForm">
          <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ *</label>
            <input type="text" name="name" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: iPhone" required>
            <div class="form-hint">–≠—Ç–æ –æ–±—â–µ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
            <div class="form-group">
              <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
              <select name="category" class="form-select" id="productCategorySelectSpecs" required>
                <option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ) *</label>
              <input type="number" name="price" class="form-input" placeholder="0" min="0" step="0.01" required>
              <div class="form-hint">–ë—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞ —Ü–µ–Ω–∞–º–∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π</div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">–û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ *</label>
            <textarea name="description" class="form-textarea" placeholder="–û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –¥–æ –≤—ã–±–æ—Ä–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏‚Ä¶" required rows="4"></textarea>
          </div>

          <!-- Image section -->
          <div class="form-group">
            <label class="form-label">–û—Å–Ω–æ–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
            <div class="img-upload-area" id="uploadAreaSpecs">
              <input type="file" name="image_file" id="imageFileSpecs" accept=".jpg,.jpeg,.png,.gif,.webp" onchange="previewImageSpecs(event)">
              <div id="uploadPlaceholderSpecs">
                <div style="font-size:2rem;margin-bottom:.5rem">üì∏</div>
                <div style="font-size:.875rem;color:var(--text-2)">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª</div>
                <div style="font-size:.75rem;color:var(--text-3);margin-top:.25rem">JPG, PNG, GIF, WebP ¬∑ –ú–∞–∫—Å. 10 –ú–ë</div>
              </div>
              <div class="img-preview" id="imgPreviewSpecs">
                <img id="previewImgSpecs" src="" alt="Preview">
                <div style="font-size:.75rem;color:var(--text-3);margin-top:.5rem" id="previewFileNameSpecs"></div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">‚Äî –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
            <input type="url" name="image_url" class="form-input" placeholder="https://example.com/image.jpg">
          </div>

          <input type="hidden" name="has_specifications" value="true">
          <input type="hidden" name="stock" value="0">
          <input type="hidden" name="featured" value="false">

          <div style="display:flex;gap:.75rem;flex-wrap:wrap">
            <button type="submit" class="btn btn-primary">üíæ –°–æ–∑–¥–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä</button>
            <button type="reset" class="btn btn-ghost" onclick="clearPreviewSpecs()">–û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
        </form>
      </div>

      <!-- Step 2: Add specifications (will be shown after main product is created) -->
      <div id="specificationsPanel" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:1.75rem;max-width:900px">
        <h3 style="font-family:var(--font-d);font-size:1.125rem;font-weight:700;margin-bottom:1.25rem">
          –®–∞–≥ 2: –î–æ–±–∞–≤—å—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏/–≤–µ—Ä—Å–∏–∏
        </h3>
        <div class="msg msg-success" style="margin-bottom:1.5rem">
          ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω! ID: <span id="createdProductId"></span><br>
          –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤—å—Ç–µ –∫ –Ω–µ–º—É –≤–µ—Ä—Å–∏–∏/–ø–æ–∫–æ–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: iPhone 13, iPhone 14, iPhone 15)
        </div>

        <form id="addSpecificationForm">
          <input type="hidden" id="specProductId" name="product_id">
          
          <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–∏/—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ *</label>
            <input type="text" name="name" class="form-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: iPhone 13" required>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
            <div class="form-group">
              <label class="form-label">–¶–µ–Ω–∞ –≤–µ—Ä—Å–∏–∏ (‚ÇΩ) *</label>
              <input type="number" name="price" class="form-input" placeholder="59990" min="1" step="0.01" required>
            </div>
            <div class="form-group">
              <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
              <input type="number" name="stock" class="form-input" value="0" min="0">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–∏</label>
            <textarea name="description" class="form-textarea" placeholder="–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏‚Ä¶" rows="3"></textarea>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
            <div class="form-group">
              <label class="form-label">–í –Ω–∞–ª–∏—á–∏–∏</label>
              <select name="in_stock" class="form-select">
                <option value="false">–ù–µ—Ç</option>
                <option value="true">‚úì –î–∞</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">–ü—Ä–µ–¥–∑–∞–∫–∞–∑</label>
              <select name="preorder" class="form-select">
                <option value="false">–ù–µ—Ç</option>
                <option value="true">üì¶ –î–∞</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <input type="url" name="image_url" class="form-input" placeholder="https://example.com/iphone13.jpg">
            <div class="form-hint">–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞</div>
          </div>

          <div style="display:flex;gap:.75rem;margin-top:1.25rem">
            <button type="submit" class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é</button>
            <button type="button" class="btn btn-ghost" onclick="finishAddingSpecs()">‚úì –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
          </div>
        </form>

        <div id="addedSpecsList" style="margin-top:2rem;padding-top:2rem;border-top:1px solid var(--border)">
          <h4 style="font-weight:700;margin-bottom:1rem">–î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏:</h4>
          <div id="specsListContent">
            <p style="color:var(--text-3);font-size:.875rem">–ü–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /admin-body -->
</div><!-- /admin-panel -->

<!-- Edit Category Modal -->
<div class="modal-overlay" id="editCatModal">
  <div class="modal-box">
    <div class="modal-header">
      <span class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</span>
      <button class="modal-close" onclick="closeModal('editCatModal')">‚úï</button>
    </div>
    <div id="editCatMsg"></div>
    <div class="form-group">
      <label class="form-label">Emoji</label>
      <input type="text" class="form-input" id="editCatEmoji" maxlength="4" style="text-align:center;font-size:1.375rem">
    </div>
    <div class="form-group">
      <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input type="text" class="form-input" id="editCatName">
    </div>
    <div class="form-group">
      <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
      <input type="text" class="form-input" id="editCatDesc">
    </div>
    <input type="hidden" id="editCatSlug">
    <div style="display:flex;gap:.75rem;margin-top:1rem">
      <button class="btn btn-primary" style="flex:1" onclick="saveCategory()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn btn-ghost" onclick="closeModal('editCatModal')">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="modal-overlay" id="editProductModal">
  <div class="modal-box" style="max-width:600px">
    <div class="modal-header">
      <span class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</span>
      <button class="modal-close" onclick="closeModal('editProductModal')">‚úï</button>
    </div>
    <div id="editProductMsg"></div>
    <form id="editProductForm">
      <input type="hidden" name="product_id" id="editProductId">
      <div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" name="name" class="form-input" id="editProductName" required></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <div class="form-group">
          <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select name="category" class="form-select" id="editProductCategory"></select>
        </div>
        <div class="form-group"><label class="form-label">–¶–µ–Ω–∞</label><input type="number" name="price" class="form-input" id="editProductPrice" min="0.01" step="0.01" required></div>
      </div>
      <div class="form-group"><label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea name="description" class="form-textarea" id="editProductDesc" rows="3" required></textarea></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
        <div class="form-group"><label class="form-label">–°–∫–ª–∞–¥</label><input type="number" name="stock" class="form-input" id="editProductStock" min="0"></div>
        <div class="form-group"><label class="form-label">–•–∏—Ç</label>
          <select name="featured" class="form-select" id="editProductFeatured">
            <option value="false">–ù–µ—Ç</option><option value="true">‚≠ê –î–∞</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">–ü–æ –ø—Ä–µ–¥–∑–∞–∫–∞–∑—É</label>
        <select name="preorder" class="form-select" id="editProductPreorder">
          <option value="false">–ù–µ—Ç</option><option value="true">üì¶ –î–∞</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">–ù–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (—Ñ–∞–π–ª)</label>
        <input type="file" name="image_file" class="form-input" accept=".jpg,.jpeg,.png,.gif,.webp">
      </div>
      <div class="form-group"><label class="form-label">‚Äî –∏–ª–∏ URL</label><input type="url" name="image_url" class="form-input" id="editProductImgUrl" placeholder="https://‚Ä¶"></div>
      <div style="display:flex;gap:.75rem;margin-top:1rem">
        <button type="submit" class="btn btn-primary" style="flex:1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn btn-ghost" onclick="closeModal('editProductModal')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  let adminToken = null;
  let categories = [];

  const toast = document.getElementById('toast');
  function showToast(type, text) {
    toast.textContent = text;
    toast.className = `toast toast-${type} show`;
    setTimeout(() => toast.classList.remove('show'), 3500);
  }
  function fmt(n) { return new Intl.NumberFormat('ru-RU').format(n); }

  function showMsg(id, type, text) {
    document.getElementById(id).innerHTML = `<div class="msg msg-${type}">${text}</div>`;
    setTimeout(() => { document.getElementById(id).innerHTML = ''; }, 5000);
  }

  function closeModal(id) { document.getElementById(id).classList.remove('active'); }

  // ‚îÄ‚îÄ Login ‚îÄ‚îÄ
  document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();
    const username = document.getElementById('loginUser').value;
    const password = document.getElementById('loginPass').value;
    try {
      const r = await fetch('/api/admin/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await r.json();
      if (r.ok) {
        adminToken = data.access_token;
        sessionStorage.setItem('adminToken', adminToken);
        showAdminPanel();
      } else {
        document.getElementById('loginMsg').innerHTML = `<div class="msg msg-error">${data.detail}</div>`;
      }
    } catch {
      document.getElementById('loginMsg').innerHTML = `<div class="msg msg-error">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>`;
    }
  });

  function showAdminPanel() {
    document.getElementById('loginScreen').style.display = 'none';
    const panel = document.getElementById('adminPanel');
    panel.style.display = 'flex';
    loadDashboard();
    loadCategories();
  }

  document.getElementById('logoutBtn').addEventListener('click', () => {
    adminToken = null; sessionStorage.removeItem('adminToken');
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('adminPanel').style.display = 'none';
  });

  // Auto-restore session
  const saved = sessionStorage.getItem('adminToken');
  if (saved) { adminToken = saved; showAdminPanel(); }

  // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
  function switchSection(name) {
    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.admin-nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`sec-${name}`)?.classList.add('active');
    document.querySelector(`[data-sec="${name}"]`)?.classList.add('active');
    if (name === 'products') loadProducts();
    if (name === 'categories') loadCategories();
    if (name === 'orders') loadOrders();
    if (name === 'dashboard') loadDashboard();
    if (name === 'top-clients') loadTopClients();
    if (name === 'crm') loadCRM();
    if (name === 'add-product') loadCategoriesForSelect();
  }

  document.querySelectorAll('.admin-nav-btn').forEach(btn => {
    btn.addEventListener('click', () => switchSection(btn.dataset.sec));
  });

  // ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
  async function loadDashboard() {
    try {
      const r = await fetch('/api/admin/stats', { headers: { Authorization: `Bearer ${adminToken}` } });
      if (!r.ok) return;
      const d = await r.json();
      document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card"><div class="stat-label">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div><div class="stat-val accent">${d.users.total}</div></div>
        <div class="stat-card"><div class="stat-label">üì¶ –¢–æ–≤–∞—Ä–æ–≤</div><div class="stat-val">${d.products.total}</div></div>
        <div class="stat-card"><div class="stat-label">‚úÖ –í –Ω–∞–ª–∏—á–∏–∏</div><div class="stat-val green">${d.products.in_stock}</div></div>
        <div class="stat-card"><div class="stat-label">‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</div><div class="stat-val red">${d.products.out_of_stock}</div></div>
        <div class="stat-card"><div class="stat-label">üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–π</div><div class="stat-val accent">${d.categories.total}</div></div>
        <div class="stat-card"><div class="stat-label">üõí –í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div><div class="stat-val">${d.orders.total}</div></div>
        <div class="stat-card"><div class="stat-label">‚è≥ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div><div class="stat-val amber">${d.orders.active}</div></div>
        <div class="stat-card"><div class="stat-label">üí∞ –í—ã—Ä—É—á–∫–∞ (–æ–ø–ª–∞—á–µ–Ω–æ)</div><div class="stat-val green">${fmt(d.orders.revenue)} ‚ÇΩ</div></div>
      `;
    } catch {}
  }

  // ‚îÄ‚îÄ Categories ‚îÄ‚îÄ
  async function loadCategories() {
    try {
      const r = await fetch('/api/categories');
      if (!r.ok) return;
      const { categories: cats } = await r.json();
      categories = cats;
      renderCatGrid(cats);
      loadCategoriesForSelect();
    } catch {}
  }

  function renderCatGrid(cats) {
    const grid = document.getElementById('catGrid');
    if (!cats.length) { grid.innerHTML = '<div style="text-align:center;color:var(--text-3);padding:2rem">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–µ—Ç</div>'; return; }
    grid.innerHTML = cats.map(c => `
      <div class="cat-card">
        <div class="cat-emoji-box">${c.emoji}</div>
        <div class="cat-info">
          <div class="cat-name">${c.name}</div>
          <div class="cat-meta">slug: ${c.slug} ¬∑ ${c.count} —Ç–æ–≤–∞—Ä(–æ–≤)</div>
        </div>
        <div class="cat-actions">
          <button class="btn btn-xs btn-secondary" onclick="openEditCat('${c.slug}','${c.name}','${c.emoji}','${(c.description||'').replace(/'/g,"\\'")}')">‚úèÔ∏è</button>
          <button class="btn btn-xs btn-danger" onclick="deleteCategory('${c.slug}','${c.count}')">üóë</button>
        </div>
      </div>
    `).join('');
  }

  function pickEmoji(emoji) {
    document.getElementById('newCatEmoji').value = emoji;
    document.querySelectorAll('.emoji-opt').forEach(el => el.classList.toggle('selected', el.textContent === emoji));
  }

  async function createCategory() {
    const slug  = document.getElementById('newCatSlug').value.trim();
    const name  = document.getElementById('newCatName').value.trim();
    const emoji = document.getElementById('newCatEmoji').value.trim() || 'üì¶';
    if (!slug || !name) { showMsg('catMsg','error','–ó–∞–ø–æ–ª–Ω–∏—Ç–µ slug –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
    if (!/^[a-z0-9_]+$/.test(slug)) { showMsg('catMsg','error','Slug: —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ _'); return; }
    try {
      const r = await fetch('/api/admin/categories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${adminToken}` },
        body: JSON.stringify({ slug, name, emoji })
      });
      const d = await r.json();
      if (r.ok) { showMsg('catMsg','success','‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞!'); loadCategories(); document.getElementById('newCatSlug').value=''; document.getElementById('newCatName').value=''; }
      else showMsg('catMsg','error', d.detail||'–û—à–∏–±–∫–∞');
    } catch { showMsg('catMsg','error','–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); }
  }

  function openEditCat(slug, name, emoji, desc) {
    document.getElementById('editCatSlug').value = slug;
    document.getElementById('editCatName').value = name;
    document.getElementById('editCatEmoji').value = emoji;
    document.getElementById('editCatDesc').value = desc;
    document.getElementById('editCatModal').classList.add('active');
  }

  async function saveCategory() {
    const slug = document.getElementById('editCatSlug').value;
    const name = document.getElementById('editCatName').value.trim();
    const emoji = document.getElementById('editCatEmoji').value.trim();
    const description = document.getElementById('editCatDesc').value.trim();
    try {
      const r = await fetch(`/api/admin/categories/${slug}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${adminToken}` },
        body: JSON.stringify({ name, emoji, description })
      });
      const d = await r.json();
      if (r.ok) { closeModal('editCatModal'); showToast('success','‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); loadCategories(); }
      else showMsg('editCatMsg','error', d.detail||'–û—à–∏–±–∫–∞');
    } catch { showMsg('editCatMsg','error','–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); }
  }

  async function deleteCategory(slug, count) {
    if (count > 0) { alert(`–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å: –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${count} —Ç–æ–≤–∞—Ä(–æ–≤). –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∏—Ö.`); return; }
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${slug}"?`)) return;
    try {
      const r = await fetch(`/api/admin/categories/${slug}`, { method:'DELETE', headers:{Authorization:`Bearer ${adminToken}`} });
      const d = await r.json();
      if (r.ok) { showToast('success','–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞'); loadCategories(); }
      else showToast('error', d.detail||'–û—à–∏–±–∫–∞');
    } catch { showToast('error','–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); }
  }

  function loadCategoriesForSelect() {
    const sel = document.getElementById('productCategorySelect');
    const selSpecs = document.getElementById('productCategorySelectSpecs');
    const editSel = document.getElementById('editProductCategory');
    const options = categories.map(c => `<option value="${c.slug}">${c.emoji} ${c.name}</option>`).join('');
    if (sel) sel.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + options;
    if (selSpecs) selSpecs.innerHTML = '<option value="">‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' + options;
    if (editSel) editSel.innerHTML = options;
  }

  // ‚îÄ‚îÄ Products ‚îÄ‚îÄ
  async function loadProducts() {
    try {
      const r = await fetch('/api/products', { headers: { Authorization: `Bearer ${adminToken}` } });
      if (!r.ok) return;
      const products = await r.json();
      const catMap = Object.fromEntries(categories.map(c => [c.slug, `${c.emoji} ${c.name}`]));
      const tbody = document.getElementById('productsTableBody');
      if (!products.length) { tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:2rem;color:var(--text-3)">–¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç</td></tr>'; return; }
      tbody.innerHTML = products.map(p => {
        const imgCell = p.image_url && p.image_url.startsWith('/static/uploads')
          ? `<div class="product-img-cell"><img src="${p.image_url}" alt="${p.name}"></div>`
          : `<div class="product-img-cell">${getCatIcon(p.category)}</div>`;
        return `<tr>
          <td>${imgCell}</td>
          <td style="max-width:200px"><div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div></td>
          <td>${catMap[p.category] || p.category}</td>
          <td class="editable-cell" onclick="editPrice(${p.id}, ${p.price})">${fmt(p.price)} ‚ÇΩ</td>
          <td class="editable-cell" onclick="editStock(${p.id}, ${p.stock})"><span style="color:${p.stock>0?'var(--green)':'var(--red)'}">${p.stock}</span></td>
          <td class="editable-cell" onclick="editCostPrice(${p.id}, ${p.cost_price || 0})">${p.cost_price ? fmt(p.cost_price) + ' ‚ÇΩ' : '‚Äî'}</td>
          <td><input type="checkbox" ${p.in_stock?'checked':''} onchange="toggleInStock(${p.id}, this.checked)" style="width:18px;height:18px;cursor:pointer"></td>
          <td><input type="checkbox" ${p.preorder?'checked':''} onchange="togglePreorder(${p.id}, this.checked)" style="width:18px;height:18px;cursor:pointer"></td>
          <td>${p.featured ? '‚≠ê' : '‚Äî'}</td>
          <td><div style="display:flex;gap:.375rem">
            <button class="btn btn-xs btn-secondary" onclick="openEditProduct(${JSON.stringify(p).replace(/"/g,'&quot;')})">‚úèÔ∏è</button>
            <button class="btn btn-xs btn-danger" onclick="deleteProduct(${p.id},'${p.name.replace(/'/g,"\\'")}')">üóë</button>
          </div></td>
        </tr>`;
      }).join('');
    } catch { console.error('Load products error'); }
  }

  // Inline editing functions
  async function editPrice(productId, currentPrice) {
    const newPrice = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É:', currentPrice);
    if (!newPrice || newPrice === currentPrice.toString()) return;
    await updateProductField(productId, 'price', parseFloat(newPrice));
  }

  async function editStock(productId, currentStock) {
    const newStock = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å–∫–ª–∞–¥–µ:', currentStock);
    if (!newStock || newStock === currentStock.toString()) return;
    await updateProductField(productId, 'stock', parseInt(newStock));
  }

  async function editCostPrice(productId, currentCost) {
    const newCost = prompt('–í–≤–µ–¥–∏—Ç–µ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:', currentCost);
    if (newCost === null) return;
    await updateProductField(productId, 'cost_price', newCost ? parseFloat(newCost) : null);
  }

  async function toggleInStock(productId, checked) {
    await updateProductField(productId, 'in_stock', checked);
  }

  async function togglePreorder(productId, checked) {
    await updateProductField(productId, 'preorder', checked);
  }

  async function updateProductField(productId, field, value) {
    const formData = new FormData();
    formData.append(field, value);
    try {
      const r = await fetch(`/api/admin/products/${productId}`, {
        method: 'PUT',
        headers: { Authorization: `Bearer ${adminToken}` },
        body: formData
      });
      if (r.ok) {
        showToast('success', '–û–±–Ω–æ–≤–ª–µ–Ω–æ');
        loadProducts();
      } else {
        const d = await r.json();
        showToast('error', d.detail || '–û—à–∏–±–∫–∞');
      }
    } catch {
      showToast('error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
  }

  function getCatIcon(cat) {
    const icons = { batteries:'üîã', motors:'‚öôÔ∏è', electronics:'üì±', brakes:'üõë', tires:'üõû', accessories:'üîß' };
    return (categories.find(c => c.slug === cat)?.emoji) || icons[cat] || 'üì¶';
  }

  function previewImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('uploadPlaceholder').style.display = 'none';
      document.getElementById('imgPreview').style.display = 'block';
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('previewFileName').textContent = file.name;
    };
    reader.readAsDataURL(file);
  }

  function clearPreview() {
    document.getElementById('uploadPlaceholder').style.display = '';
    document.getElementById('imgPreview').style.display = 'none';
    document.getElementById('previewImg').src = '';
    document.getElementById('imageFile').value = '';
  }

  // Add product form
  document.getElementById('addProductForm').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const msgEl = document.getElementById('addProductMsg');
    try {
      const r = await fetch('/api/admin/products', {
        method: 'POST',
        headers: { Authorization: `Bearer ${adminToken}` },
        body: formData
      });
      const d = await r.json();
      if (r.ok) {
        showMsg('addProductMsg','success','‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
        e.target.reset(); clearPreview();
      } else showMsg('addProductMsg','error', d.detail||'–û—à–∏–±–∫–∞');
    } catch { showMsg('addProductMsg','error','–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); }
  });

  // ‚îÄ‚îÄ‚îÄ PRODUCT WITH SPECIFICATIONS ‚îÄ‚îÄ‚îÄ
  let currentProductWithSpecs = null;
  let addedSpecifications = [];

  function previewImageSpecs(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('uploadPlaceholderSpecs').style.display = 'none';
      document.getElementById('imgPreviewSpecs').style.display = 'block';
      document.getElementById('previewImgSpecs').src = e.target.result;
      document.getElementById('previewFileNameSpecs').textContent = file.name;
    };
    reader.readAsDataURL(file);
  }

  function clearPreviewSpecs() {
    document.getElementById('uploadPlaceholderSpecs').style.display = '';
    document.getElementById('imgPreviewSpecs').style.display = 'none';
    document.getElementById('previewImgSpecs').src = '';
    document.getElementById('imageFileSpecs').value = '';
  }

  // Add main product with specifications
  document.getElementById('addProductWithSpecsForm').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    try {
      const r = await fetch('/api/admin/products', {
        method: 'POST',
        headers: { Authorization: `Bearer ${adminToken}` },
        body: formData
      });
      const d = await r.json();
      if (r.ok) {
        currentProductWithSpecs = d.product;
        addedSpecifications = [];
        document.getElementById('createdProductId').textContent = d.product.id;
        document.getElementById('specProductId').value = d.product.id;
        document.getElementById('specificationsPanel').style.display = 'block';
        showMsg('addProductSpecsMsg','success','‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —Ç–æ–≤–∞—Ä —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤—å—Ç–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∏–∂–µ');
        e.target.reset(); 
        clearPreviewSpecs();
        // Scroll to specifications panel
        document.getElementById('specificationsPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        showMsg('addProductSpecsMsg','error', d.detail||'–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞');
      }
    } catch { 
      showMsg('addProductSpecsMsg','error','–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); 
    }
  });

  // Add specification to product
  document.getElementById('addSpecificationForm').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const productId = document.getElementById('specProductId').value;
    
    try {
      const r = await fetch(`/api/admin/products/${productId}/specifications`, {
        method: 'POST',
        headers: { Authorization: `Bearer ${adminToken}` },
        body: formData
      });
      const d = await r.json();
      if (r.ok) {
        addedSpecifications.push(d.specification);
        updateSpecsList();
        showToast('success', '‚úÖ –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
        e.target.reset();
        // Keep product_id
        document.getElementById('specProductId').value = productId;
      } else {
        showToast('error', d.detail || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏');
      }
    } catch {
      showToast('error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
  });

  function updateSpecsList() {
    const container = document.getElementById('specsListContent');
    if (addedSpecifications.length === 0) {
      container.innerHTML = '<p style="color:var(--text-3);font-size:.875rem">–ü–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>';
      return;
    }

    container.innerHTML = addedSpecifications.map((spec, idx) => `
      <div style="padding:1rem;background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:.75rem">
        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:.5rem">
          <div>
            <strong style="font-size:.9375rem">${idx + 1}. ${spec.name}</strong>
            <div style="font-size:.875rem;color:var(--text-2);margin-top:.25rem">
              –¶–µ–Ω–∞: ${fmt(spec.price)} ‚ÇΩ ¬∑ –°–∫–ª–∞–¥: ${spec.stock} —à—Ç.
            </div>
          </div>
          <span class="badge ${spec.in_stock ? 'badge-success' : 'badge-danger'}" style="font-size:.75rem">
            ${spec.in_stock ? '‚úì –í –Ω–∞–ª–∏—á–∏–∏' : '‚úï –ù–µ—Ç'}
          </span>
        </div>
        ${spec.description ? `<p style="font-size:.8125rem;color:var(--text-3);margin-top:.5rem">${spec.description}</p>` : ''}
      </div>
    `).join('');
  }

  function finishAddingSpecs() {
    if (addedSpecifications.length === 0) {
      alert('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º!');
      return;
    }
    showToast('success', `‚úÖ –¢–æ–≤–∞—Ä —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è–º–∏ –≥–æ—Ç–æ–≤! –î–æ–±–∞–≤–ª–µ–Ω–æ ${addedSpecifications.length} –≤–µ—Ä—Å–∏–π`);
    // Reset form
    document.getElementById('addProductWithSpecsForm').reset();
    document.getElementById('addSpecificationForm').reset();
    document.getElementById('specificationsPanel').style.display = 'none';
    currentProductWithSpecs = null;
    addedSpecifications = [];
    updateSpecsList();
    // Switch to products view
    switchSection('products');
    loadProducts();
  }

  function openEditProduct(product) {
    document.getElementById('editProductId').value = product.id;
    document.getElementById('editProductName').value = product.name;
    document.getElementById('editProductPrice').value = product.price;
    document.getElementById('editProductDesc').value = product.description;
    document.getElementById('editProductStock').value = product.stock;
    document.getElementById('editProductFeatured').value = product.featured ? 'true' : 'false';
    document.getElementById('editProductPreorder').value = product.preorder ? 'true' : 'false';
    document.getElementById('editProductImgUrl').value = product.image_url || '';
    // Populate category select
    const sel = document.getElementById('editProductCategory');
    sel.innerHTML = categories.map(c => `<option value="${c.slug}" ${c.slug===product.category?'selected':''}>${c.emoji} ${c.name}</option>`).join('');
    document.getElementById('editProductModal').classList.add('active');
  }

  document.getElementById('editProductForm').addEventListener('submit', async e => {
    e.preventDefault();
    const productId = document.getElementById('editProductId').value;
    const formData = new FormData(e.target);
    formData.delete('product_id');
    try {
      const r = await fetch(`/api/admin/products/${productId}`, {
        method: 'PUT',
        headers: { Authorization: `Bearer ${adminToken}` },
        body: formData
      });
      const d = await r.json();
      if (r.ok) { closeModal('editProductModal'); showToast('success','‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω'); loadProducts(); }
      else showMsg('editProductMsg','error', d.detail||'–û—à–∏–±–∫–∞');
    } catch { showMsg('editProductMsg','error','–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); }
  });

  async function deleteProduct(id, name) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${name}"?`)) return;
    try {
      const r = await fetch(`/api/admin/products/${id}`, { method:'DELETE', headers:{Authorization:`Bearer ${adminToken}`} });
      const d = await r.json();
      if (r.ok) { showToast('success','–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω'); loadProducts(); }
      else showToast('error', d.detail||'–û—à–∏–±–∫–∞');
    } catch { showToast('error','–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); }
  }

  // ‚îÄ‚îÄ Orders ‚îÄ‚îÄ
  async function loadOrders() {
    const statusFilter = document.getElementById('orderStatusFilter').value;
    let url = '/api/admin/orders?limit=100';
    if (statusFilter) url += `&status=${statusFilter}`;
    try {
      const r = await fetch(url, { headers: { Authorization: `Bearer ${adminToken}` } });
      if (!r.ok) return;
      const orders = await r.json();
      const tbody = document.getElementById('ordersTableBody');
      if (!orders.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-3)">–ó–∞–∫–∞–∑–æ–≤ –Ω–µ—Ç</td></tr>'; return; }
      const statusLabels = { pending:'‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ', confirmed:'‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω', processing:'‚öôÔ∏è –í –æ–±—Ä–∞–±–æ—Ç–∫–µ', shipped:'üì¶ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω', delivered:'üéâ –î–æ—Å—Ç–∞–≤–ª–µ–Ω', cancelled:'‚ùå –û—Ç–º–µ–Ω—ë–Ω' };
      const statusClass = { pending:'status-pending', confirmed:'status-confirmed', processing:'status-processing', shipped:'status-shipped', delivered:'status-delivered', cancelled:'status-cancelled' };
      tbody.innerHTML = orders.map(o => `<tr>
        <td style="font-weight:700">#${o.id}</td>
        <td><div>${o.username||'‚Äî'}</div><div style="font-size:.75rem;color:var(--text-3)">${o.email||''}</div></td>
        <td style="font-weight:700">${fmt(o.total_amount)} ‚ÇΩ</td>
        <td><span class="order-status ${statusClass[o.status]||''}">${statusLabels[o.status]||o.status}</span></td>
        <td><span style="font-size:.8125rem;color:${o.payment_status==='paid'?'var(--green)':'var(--text-3)'}">${o.payment_status==='paid'?'üíö –û–ø–ª–∞—á–µ–Ω':o.payment_status==='waiting'?'‚è≥ –û–∂–∏–¥–∞–µ—Ç':'üíî –ù–µ –æ–ø–ª–∞—á–µ–Ω'}</span></td>
        <td style="font-size:.8125rem;color:var(--text-3)">${o.created_at?.split('T')[0]||'‚Äî'}</td>
        <td>
          <select class="form-select" style="font-size:.75rem;padding:.25rem .5rem;background:var(--bg-3)" onchange="updateOrderStatus(${o.id},this.value)">
            <option value="">–ò–∑–º–µ–Ω–∏—Ç—å‚Ä¶</option>
            <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</option>
            <option value="processing">–í –æ–±—Ä–∞–±–æ—Ç–∫—É</option>
            <option value="shipped">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</option>
            <option value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
            <option value="cancelled">–û—Ç–º–µ–Ω–∏—Ç—å</option>
          </select>
        </td>
      </tr>`).join('');
    } catch {}
  }

  async function updateOrderStatus(orderId, newStatus) {
    if (!newStatus) return;
    try {
      const r = await fetch(`/api/admin/orders/${orderId}/status`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${adminToken}` },
        body: JSON.stringify({ status: newStatus })
      });
      const d = await r.json();
      if (r.ok) { showToast('success', `–ó–∞–∫–∞–∑ #${orderId}: —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω`); loadOrders(); }
      else showToast('error', d.detail||'–û—à–∏–±–∫–∞');
    } catch { showToast('error','–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); }
  }


  // ‚îÄ‚îÄ Top Clients: Load Top Customers ‚îÄ‚îÄ
  async function loadTopClients() {
    const tbody = document.getElementById('topClientsTableBody');
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-3)">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
    try {
      const r = await fetch('/api/admin/top-customers?limit=50', {
        headers: { Authorization: `Bearer ${adminToken}` }
      });
      const customers = await r.json();
      if (!r.ok) throw new Error('Failed to load');
      
      if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--text-3)">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π</td></tr>';
        return;
      }
      
      tbody.innerHTML = customers.map((c, idx) => {
        const lastOrder = c.last_order_date ? new Date(c.last_order_date).toLocaleDateString('ru-RU') : '‚Äî';
        const profit = (c.total_spent || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        return `
          <tr>
            <td><strong>${idx + 1}</strong></td>
            <td><strong>${c.full_name || c.username}</strong></td>
            <td style="color:var(--text-2)">${c.email}</td>
            <td style="color:var(--text-2)">${c.phone || '‚Äî'}</td>
            <td><span class="badge badge-accent">${c.order_count}</span></td>
            <td><span class="badge badge-success">${c.paid_orders}</span></td>
            <td><strong style="font-family:'JetBrains Mono',monospace;color:var(--green)">${profit} ‚ÇΩ</strong></td>
            <td style="color:var(--text-2);font-size:.8125rem">${lastOrder}</td>
          </tr>
        `;
      }).join('');
    } catch (err) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--red)">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    }
  }


  // ‚îÄ‚îÄ CRM: Load Customers with Notes ‚îÄ‚îÄ
  let currentCustomerId = null;

  async function loadCRM() {
    const tbody = document.getElementById('crmTableBody');
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-3)">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
    try {
      const r = await fetch('/api/admin/customers', {
        headers: { Authorization: `Bearer ${adminToken}` }
      });
      const customers = await r.json();
      if (!r.ok) throw new Error('Failed to load');
      
      if (customers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--text-3)">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π</td></tr>';
        return;
      }
      
      tbody.innerHTML = customers.map((c) => {
        const lastOrder = c.last_order_date ? new Date(c.last_order_date).toLocaleDateString('ru-RU') : '‚Äî';
        const profit = (c.total_spent || 0).toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const vipBadge = c.total_spent > 100000 ? '<span class="badge badge-warning" style="margin-left:.5rem">VIP</span>' : '';
        
        return `
          <tr>
            <td>
              <strong>${c.full_name || c.username}</strong>${vipBadge}
              <div style="font-size:.8125rem;color:var(--text-2)">${c.email}</div>
            </td>
            <td><span class="badge badge-accent">${c.order_count}</span></td>
            <td><strong style="font-family:'JetBrains Mono',monospace;color:var(--green)">${profit} ‚ÇΩ</strong></td>
            <td style="color:var(--text-2);font-size:.8125rem">${lastOrder}</td>
            <td><span class="badge badge-success">${c.notes_count || 0}</span></td>
            <td>
              <button class="btn btn-xs btn-secondary" onclick="openNotes('${c.id}', '${c.full_name || c.username}')">üìù –ó–∞–º–µ—Ç–∫–∏</button>
            </td>
          </tr>
        `;
      }).join('');
    } catch (err) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--red)">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    }
  }

  async function openNotes(userId, userName) {
    currentCustomerId = userId;
    document.getElementById('notesCustomerName').textContent = userName;
    document.getElementById('notesModal').classList.add('active');
    await loadNotes(userId);
  }

  async function loadNotes(userId) {
    const notesList = document.getElementById('notesList');
    notesList.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-3)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    
    try {
      const r = await fetch(`/api/admin/customers/${userId}/notes`, {
        headers: { Authorization: `Bearer ${adminToken}` }
      });
      const notes = await r.json();
      
      if (notes.length === 0) {
        notesList.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--text-3)">–ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
        return;
      }
      
      notesList.innerHTML = notes.map(n => {
        const date = new Date(n.created_at).toLocaleString('ru-RU');
        return `
          <div style="background:var(--bg-2);padding:1rem;border-radius:12px;margin-bottom:.75rem;border:1px solid var(--border)">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;font-size:.75rem;color:var(--text-3)">
              <span>${n.created_by} ‚Ä¢ ${date}</span>
              <button class="btn btn-xs btn-danger" onclick="deleteNote(${n.id})">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
            <div style="color:var(--text-2);line-height:1.6">${n.note}</div>
          </div>
        `;
      }).join('');
    } catch (err) {
      notesList.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--red)">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–º–µ—Ç–æ–∫</div>';
    }
  }

  async function saveNote() {
    const noteText = document.getElementById('newNoteText').value.trim();
    if (!noteText) {
      showToast('error', '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏');
      return;
    }
    
    try {
      const r = await fetch(`/api/admin/customers/${currentCustomerId}/notes`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${adminToken}`
        },
        body: JSON.stringify({ note: noteText })
      });
      
      if (r.ok) {
        document.getElementById('newNoteText').value = '';
        showToast('success', '–ó–∞–º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
        await loadNotes(currentCustomerId);
        await loadCRM(); // –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–º–µ—Ç–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
      } else {
        const d = await r.json();
        showToast('error', d.detail || '–û—à–∏–±–∫–∞');
      }
    } catch {
      showToast('error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
  }

  async function deleteNote(noteId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) return;
    
    try {
      const r = await fetch(`/api/admin/customers/notes/${noteId}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${adminToken}` }
      });
      
      if (r.ok) {
        showToast('success', '–ó–∞–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
        await loadNotes(currentCustomerId);
        await loadCRM();
      } else {
        const d = await r.json();
        showToast('error', d.detail || '–û—à–∏–±–∫–∞');
      }
    } catch {
      showToast('error', '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
    }
  }


  // Mobile menu toggle
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const adminNav = document.getElementById('adminNav');
  if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', () => {
      mobileMenuBtn.classList.toggle('active');
      adminNav.classList.toggle('active');
    });
    // Close menu when clicking nav item
    document.querySelectorAll('.admin-nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        mobileMenuBtn.classList.remove('active');
        adminNav.classList.remove('active');
      });
    });
  }

  // Close modals on overlay click
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.classList.remove('active'); });
  });
</script>
</body>
</html>
